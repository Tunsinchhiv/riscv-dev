# Buildroot SDK Integration Guide

This guide covers integrating Go applications into Buildroot-based embedded Linux systems for RISC-V development, including package creation, configuration, and deployment strategies.

## Table of Contents

- [Buildroot Overview](#buildroot-overview)
- [Package Structure](#package-structure)
- [Creating a Go Package](#creating-a-go-package)
- [Buildroot Configuration](#buildroot-configuration)
- [Cross-Compilation in Buildroot](#cross-compilation-in-buildroot)
- [Deployment and Testing](#deployment-and-testing)
- [Advanced Integration](#advanced-integration)
- [Troubleshooting](#troubleshooting)

## Buildroot Overview

### What is Buildroot?

Buildroot is a tool for generating embedded Linux systems. It automates the process of:

- **Cross-compilation** of user-space applications
- **Root filesystem** creation
- **Kernel and bootloader** configuration
- **Package management** for embedded systems

### Why Use Buildroot with RISC-V?

- **Reproducible builds** across different development machines
- **Small footprint** optimized for embedded systems
- **Package management** for complex software stacks
- **Automated toolchain** setup
- **Integrated development** environment

### Supported RISC-V Boards

Popular RISC-V boards with Buildroot support:

| Board | Architecture | Buildroot Defconfig |
|-------|-------------|-------------------|
| Milk-V Duo | RV64GC | `milkv_duo_sd_defconfig` |
| HiFive Unmatched | RV64GC | `hifive_unmatched_defconfig` |
| QEMU RISC-V | RV64GC | `qemu_riscv64_virt_defconfig` |
| StarFive VisionFive 2 | RV64GC | `starfive_visionfive2_defconfig` |

## Package Structure

### Basic Package Layout

```
buildroot/
├── package/
│   └── myapp/
│       ├── Config.in           # Package configuration
│       ├── myapp.mk           # Build instructions
│       └── rootfs-overlay/    # Files to install
│           └── etc/
│               ├── systemd/system/
│               └── init.d/
├── configs/                    # Board configurations
└── board/                      # Board-specific files
```

### Go Application Package Structure

```
my-riscv-app/
├── buildroot-package/          # Buildroot integration
│   ├── Config.in              # Package config
│   ├── riscv-app.mk          # Build makefile
│   └── rootfs-overlay/       # Installation files
│       ├── etc/
│       │   ├── systemd/system/
│       │   │   └── riscv-app.service
│       │   └── init.d/
│       │       └── S99riscv-app
│       └── usr/bin/
│           └── riscv-app      # (generated by build)
├── cmd/app/
│   └── main.go               # Go application
├── go.mod                    # Go modules
└── README.md                 # Documentation
```

## Creating a Go Package

### Step 1: Package Configuration (Config.in)

```bash
# package/Config.in
config BR2_PACKAGE_RISCV_APP
    bool "riscv-app"
    depends on BR2_PACKAGE_HOST_GO_TARGET_ARCH_SUPPORTS
    help
      RISC-V demonstration application written in Go.

      This package builds a Go application that demonstrates
      RISC-V hardware interaction, including GPIO control,
      networking, and sensor interfaces.
```

### Step 2: Package Makefile (riscv-app.mk)

```makefile
################################################################################
#
# riscv-app
#
################################################################################

RISCV_APP_VERSION = 1.0.0
RISCV_APP_SITE = $(TOPDIR)/../examples/buildroot-app
RISCV_APP_SITE_METHOD = local
RISCV_APP_LICENSE = MIT
RISCV_APP_LICENSE_FILES = LICENSE

# Go build configuration
RISCV_APP_GO_ENV = \
    GOOS=linux \
    GOARCH=riscv64 \
    CGO_ENABLED=0 \
    GOPATH=$(HOST_DIR)/go

# Build the Go application
define RISCV_APP_BUILD_CMDS
    cd $(@D)/cmd/app && \
        $(RISCV_APP_GO_ENV) $(HOST_DIR)/bin/go build \
            -ldflags="-s -w -X main.version=$(RISCV_APP_VERSION)" \
            -gcflags="all=-l" \
            -o $(@D)/riscv-app \
            ./main.go
endef

# Install the application binary
define RISCV_APP_INSTALL_TARGET_CMDS
    $(INSTALL) -D -m 0755 $(@D)/riscv-app \
        $(TARGET_DIR)/usr/bin/riscv-app
endef

# Install systemd service
define RISCV_APP_INSTALL_INIT_SYSTEMD
    $(INSTALL) -D -m 0644 $(@D)/buildroot-package/rootfs-overlay/etc/systemd/system/riscv-app.service \
        $(TARGET_DIR)/etc/systemd/system/riscv-app.service
endef

# Install init.d script
define RISCV_APP_INSTALL_INIT_SYSV
    $(INSTALL) -D -m 0755 $(@D)/buildroot-package/rootfs-overlay/etc/init.d/S99riscv-app \
        $(TARGET_DIR)/etc/init.d/S99riscv-app
endef

$(eval $(generic-package))
```

### Step 3: System Service Configuration

#### systemd Service File

```ini
# rootfs-overlay/etc/systemd/system/riscv-app.service
[Unit]
Description=RISC-V Application Service
After=network.target
Wants=network.target

[Service]
Type=simple
User=root
Group=root
ExecStart=/usr/bin/riscv-app
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal
SyslogIdentifier=riscv-app

# Security settings
NoNewPrivileges=yes
ProtectHome=yes
ProtectSystem=strict
ReadWritePaths=/tmp /var/log
PrivateTmp=yes

# Resource limits
MemoryLimit=50M
CPUQuota=10%

[Install]
WantedBy=multi-user.target
```

#### Traditional init.d Script

```bash
# rootfs-overlay/etc/init.d/S99riscv-app
#!/bin/sh
#
# Start/stop the RISC-V Application
#

DAEMON="/usr/bin/riscv-app"
NAME="riscv-app"
DESC="RISC-V Application Service"
PIDFILE="/var/run/$NAME.pid"

# Exit if the package is not installed
[ -x "$DAEMON" ] || exit 0

case "$1" in
    start)
        log_daemon_msg "Starting $DESC" "$NAME"
        start-stop-daemon --start --quiet --background \
            --pidfile $PIDFILE --make-pidfile \
            --exec $DAEMON \
            -- $DAEMON_OPTS
        log_end_msg $?
        ;;
    stop)
        log_daemon_msg "Stopping $DESC" "$NAME"
        start-stop-daemon --stop --quiet --pidfile $PIDFILE \
            --retry 5
        log_end_msg $?
        rm -f $PIDFILE
        ;;
    restart|force-reload)
        $0 stop
        sleep 1
        $0 start
        ;;
    status)
        status_of_proc -p $PIDFILE "$DAEMON" "$NAME" && exit 0 || exit $?
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|force-reload|status}" >&2
        exit 1
        ;;
esac

exit 0
```

## Buildroot Configuration

### Step 1: Add Package to Buildroot

```bash
# Copy package files
cp riscv-app/Config.in /path/to/buildroot/package/
cp riscv-app/riscv-app.mk /path/to/buildroot/package/

# Or for this repository's example:
cp examples/buildroot-app/buildroot-package/* /path/to/buildroot/package/
```

### Step 2: Enable Package

```bash
cd /path/to/buildroot

# Interactive configuration
make menuconfig
# Navigate to: Target packages → riscv-app
# Enable with spacebar

# Or use defconfig
echo 'BR2_PACKAGE_RISCV_APP=y' >> configs/my_custom_defconfig
```

### Step 3: Configure Build Options

```bash
# Set Go version requirement
BR2_PACKAGE_HOST_GO=y

# Enable systemd or init.d
BR2_INIT_SYSTEMD=y
# or
BR2_INIT_SYSV=y
```

### Step 4: Build the System

```bash
# Build everything
make

# Build only the package
make riscv-app

# Check build output
ls -la output/target/usr/bin/riscv-app
```

## Cross-Compilation in Buildroot

### Go Toolchain Integration

Buildroot automatically handles Go cross-compilation:

```makefile
# Automatic Go environment setup
RISCV_APP_GO_ENV = \
    GOOS=linux \
    GOARCH=riscv64 \
    CGO_ENABLED=0 \
    GOPATH=$(HOST_DIR)/go
```

### Build Optimization

```makefile
# Optimized flags for embedded systems
define RISCV_APP_BUILD_CMDS
    $(RISCV_APP_GO_ENV) $(HOST_DIR)/bin/go build \
        -ldflags="-s -w" \        # Strip symbols and debug info
        -gcflags="all=-l" \       # Disable inlining
        -trimpath \               # Remove file paths
        -o $(@D)/riscv-app \
        ./cmd/app
endef
```

### Dependency Management

```makefile
# Handle Go modules
define RISCV_APP_BUILD_CMDS
    cd $(@D) && \
    $(RISCV_APP_GO_ENV) $(HOST_DIR)/bin/go mod download && \
    $(RISCV_APP_GO_ENV) $(HOST_DIR)/bin/go build \
        -mod=readonly \
        -o riscv-app \
        ./cmd/app
endef
```

## Deployment and Testing

### SD Card Deployment

```bash
# Write Buildroot image to SD card
sudo dd if=output/images/sdcard.img of=/dev/sdX bs=4M conv=fsync

# Or for this repository's example
cd riscv-dev-standalone
make build-image  # If Buildroot SDK is available
sudo dd if=/opt/duo-buildroot-sdk/output/images/milkv-duo-sd.img of=/dev/sdX bs=4M
```

### Network Deployment

```bash
# Copy via network
scp output/target/usr/bin/riscv-app root@riscv-board:/usr/bin/

# Install service
scp riscv-app.service root@riscv-board:/etc/systemd/system/
ssh root@riscv-board systemctl enable riscv-app
ssh root@riscv-board systemctl start riscv-app
```

### Testing the Deployment

```bash
# Connect to board
ssh root@riscv-board

# Check if application is running
ps aux | grep riscv-app

# Test the service
systemctl status riscv-app
journalctl -u riscv-app -f

# Test the application
curl http://localhost:8080/health  # If web-enabled
```

## Advanced Integration

### Custom Root Filesystem Overlay

```bash
# Directory structure for overlay
rootfs-overlay/
├── etc/
│   ├── systemd/system/riscv-app.service
│   └── config/
│       └── riscv-app.yaml
├── usr/
│   ├── bin/riscv-app
│   └── share/riscv-app/
│       └── templates/
└── var/
    └── log/riscv-app/
```

### Device Tree Integration

```c
// Device tree overlay for custom hardware
/dts-v1/;
/plugin/;

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/pinctrl/pinctrl.h>

/ {
    fragment@0 {
        target = <&gpio>;
        __overlay__ {
            riscv_app_pins: riscv-app-pins {
                pins = "GPIO17", "GPIO18";
                function = "gpio";
                bias-pull-up;
            };
        };
    };
};
```

### Kernel Module Dependencies

```makefile
# Package dependencies
RISCV_APP_DEPENDENCIES = linux

# Kernel configuration
define RISCV_APP_LINUX_CONFIG_FIXUPS
    $(call KCONFIG_ENABLE_OPT,CONFIG_GPIO_SYSFS)
    $(call KCONFIG_ENABLE_OPT,CONFIG_SPI)
    $(call KCONFIG_ENABLE_OPT,CONFIG_I2C)
endef
```

### Multi-Package Applications

```makefile
# Library package
define RISCV_APP_LIB_BUILD_CMDS
    cd $(@D)/pkg/lib && \
    $(RISCV_APP_GO_ENV) $(HOST_DIR)/bin/go build \
        -buildmode=archive \
        -o $(@D)/lib.a \
        .
endef

# Main application
define RISCV_APP_BUILD_CMDS
    $(RISCV_APP_GO_ENV) $(HOST_DIR)/bin/go build \
        -ldflags="-L $(@D) -l riscv_app_lib" \
        -o $(@D)/riscv-app \
        ./cmd/app
endef
```

## Troubleshooting

### Common Build Issues

#### 1. "Host Go not found"

**Problem**: Go not installed in Buildroot host tools

**Solution**:
```bash
# Enable Go in Buildroot config
make menuconfig
# Target packages → Host utilities → host-go
```

#### 2. "Cross-compilation failed"

**Problem**: Architecture mismatch

**Solution**:
```makefile
# Verify architecture
echo $(BR2_ARCH)
# Should match GOARCH=riscv64
```

#### 3. "Service not starting"

**Problem**: Service configuration issues

**Solution**:
```bash
# Check service status
systemctl status riscv-app

# Check logs
journalctl -u riscv-app

# Manual test
/usr/bin/riscv-app
```

#### 4. "Permission denied"

**Problem**: File permissions not set correctly

**Solution**:
```makefile
# Fix permissions in makefile
define RISCV_APP_INSTALL_TARGET_CMDS
    $(INSTALL) -D -m 0755 $(@D)/riscv-app \
        $(TARGET_DIR)/usr/bin/riscv-app
endef
```

### Performance Optimization

#### Binary Size Reduction

```makefile
# Aggressive optimization
define RISCV_APP_BUILD_CMDS
    $(RISCV_APP_GO_ENV) $(HOST_DIR)/bin/go build \
        -ldflags="-s -w -buildid= -extldflags=-static" \
        -gcflags="all=-l -B" \
        -asmflags="all=-l" \
        -trimpath \
        -o $(@D)/riscv-app \
        ./cmd/app
endef
```

#### Startup Time Optimization

```bash
# Pre-link dependencies
$(HOST_DIR)/bin/go build -buildmode=pie ./cmd/app
```

### Debugging Buildroot Packages

#### Enable Debug Output

```bash
# Verbose build
make V=1 riscv-app

# Check build logs
tail -f $(BUILD_DIR)/build/riscv-app-*/.stamp_*
```

#### Local Build Testing

```bash
# Build outside Buildroot first
cd examples/buildroot-app
GOOS=linux GOARCH=riscv64 CGO_ENABLED=0 go build ./cmd/app

# Test with QEMU
qemu-riscv64 ./main
```

## Best Practices

### Package Organization

1. **Single Responsibility**: One package per application
2. **Clear Dependencies**: Explicit dependency declarations
3. **Version Management**: Proper version numbering
4. **Documentation**: Include README and usage examples

### Security Considerations

```makefile
# Secure installation
define RISCV_APP_INSTALL_TARGET_CMDS
    $(INSTALL) -D -m 0755 $(@D)/riscv-app \
        $(TARGET_DIR)/usr/bin/riscv-app
    $(INSTALL) -d -m 0755 $(TARGET_DIR)/etc/riscv-app
endef
```

### Maintenance

```makefile
# Version information
RISCV_APP_VERSION = $(shell git describe --tags --dirty)
RISCV_APP_SITE = $(shell git config --get remote.origin.url)
RISCV_APP_SITE_METHOD = git
```

## Resources

- [Buildroot Documentation](https://buildroot.org/docs.html)
- [Go Buildroot Package](https://github.com/buildroot/buildroot/tree/master/package/go)
- [RISC-V Buildroot](https://github.com/buildroot/buildroot/tree/master/configs)
- [Embedded Linux with Buildroot](https://bootlin.com/doc/training/buildroot/)

## Examples in this Repository

This repository includes a complete Buildroot package example:

- **Package Files**: `examples/buildroot-app/buildroot-package/`
- **Go Application**: `examples/buildroot-app/cmd/app/main.go`
- **Service Configuration**: Both systemd and init.d support
- **Documentation**: Complete integration guide

To use the example:

```bash
# 1. Copy to Buildroot
cp examples/buildroot-app/buildroot-package/* /path/to/buildroot/package/

# 2. Enable package
make menuconfig  # Enable riscv-system-monitor

# 3. Build and deploy
make
```

For more information, see the [Buildroot App Example](../examples/buildroot-app/) documentation.
